<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<title>إرسال رسالة</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{ --green:#0a7a3a; --white:#ffffff; --gold:#ffd700; }
body{ margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family:"Tajawal",sans-serif; background: linear-gradient(135deg,var(--green),#04733a);}
.card{ width:420px; padding:40px; border-radius:12px; border-color:var(--white);background:var(--white); color:#ecd5d5; box-shadow:0 8px 28px rgba(0,0,0,0.35);}
input, textarea { width:100%; padding:10px;align-items: center; margin-top:10px; border-radius:8px; border:var(--white); background: rgba(17, 72, 16, 0.25); color:#000000; }
button { width:100%; margin-top:12px; padding:10px; border-radius:8px; border:none; background:rgb(69, 157, 69); font-weight:700; cursor:pointer;}
.status{ min-height:18px; margin-top:8px; color:#fff; opacity:0.95; text-align:center; }
</style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 8px 0;text-align:center; color:var(--green)">أرسل رسالتك</h2>
    <input id="name" placeholder="اسمك الثلاثي" maxlength="60" />
    <textarea id="text" rows="4" placeholder="ماذا تقول لوطنك..." maxlength="300"></textarea>
    <button id="sendBtn">إرسال</button>
    <div class="status" id="status"></div>
  </div>

<script>
const sendBtn = document.getElementById('sendBtn');
const status = document.getElementById('status');
let canSend = true;
const COOLDOWN = 5000;
const TIMEOUT = 6000;

function show(msg, ok=true){
  status.style.color = ok ? '#dff0d8' : '#ffb3b3';
  status.textContent = msg || '';
}

function fetchWithTimeout(url, opts={}, timeout=TIMEOUT){
  const controller = new AbortController();
  const id = setTimeout(()=> controller.abort(), timeout);
  return fetch(url, {...opts, signal: controller.signal}).finally(()=> clearTimeout(id));
}

sendBtn.addEventListener('click', async ()=>{
  if (!canSend) { show('⌛ انتظر قليلاً', false); return; }
  const name = (document.getElementById('name').value||'').trim();
  const text = (document.getElementById('text').value||'').trim();
  if (!name || !text) { show('رجاءً أدخل الاسم والرسالة', false); return; }
  canSend = false; sendBtn.disabled = true; show('⏳ جارٍ الإرسال...');
  try {
    const res = await fetchWithTimeout('/api/post', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name, text})
    });
    if (!res.ok) {
      const body = await res.json().catch(()=>({}));
      show('❌ ' + (body.error || 'خطأ من السيرفر'), false);
    } else {
      show('✅ تم الإرسال', true);
      document.getElementById('name').value = '';
      document.getElementById('text').value = '';
    }
  } catch (err) {
    show('❌ فشل الاتصال', false);
  } finally {
    setTimeout(()=> { canSend = true; sendBtn.disabled = false; show(''); }, COOLDOWN);
  }
});
</script>
</body>
</html>
